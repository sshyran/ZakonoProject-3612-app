"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function t(t,e){var i=[],n=!0,r=!1,o=undefined;try{for(var a,c=t[Symbol.iterator]();!(n=(a=c.next()).done)&&(i.push(a.value),!e||i.length!==e);n=!0);}catch(u){r=!0,o=u}finally{try{!n&&c["return"]&&c["return"]()}finally{if(r)throw o}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();!function(t){var e=function(){function e(t){_classCallCheck(this,e),this.$form=t,this.id=this.$form.attr("id")||this._getUID(),this.mounted=!1,this._onFormChange=this._onFormChange.bind(this),this._onPopState=this._onPopState.bind(this),window.Decidim.PopStateHandler?this.popStateSubmiter=!1:(this.popStateSubmiter=!0,window.Decidim.PopStateHandler=this.id)}return _createClass(e,[{key:"unmountComponent",value:function(){this.mounted&&(this.mounted=!1,this.$form.off("change","input, select",this._onFormChange),t.Decidim.History.unregisterCallback("filters-"+this.id))}},{key:"mountComponent",value:function(){var e=this;this.$form.length>0&&!this.mounted&&(this.mounted=!0,this.$form.on("change","input, select",this._onFormChange),t.Decidim.History.registerCallback("filters-"+this.id,function(t){e._onPopState(t)}))}},{key:"_getLocation",value:function(){return t.location.toString()}},{key:"_getLocationParams",value:function(t){var e=decodeURIComponent(this._getLocation()).match(t);return e&&(e=e.map(function(t){return t.match(/=(.*)/)[1]})),e}},{key:"_parseLocationFilterValues",value:function(){var t=decodeURIComponent(this._getLocation()).match(/filter\[([^\]]*)\](?:\[\])?=([^&]*)/g);return t?t.reduce(function(t,e){var i=e.match(/filter\[([^\]]*)\](\[\])?=([^&]*)/),n=_slicedToArray(i,4),r=n[1],o=n[2],a=n[3];return o?(t[r]||(t[r]=[]),t[r].push(a)):t[r]=a,t},{}):null}},{key:"_parseLocationOrderValue",value:function(){var t=this._getLocation().match(/order=([^&]*)/),e=this.$form.find(".order-by .menu").find(".menu a:first").data("order");return t&&(e=t[1]),e}},{key:"_clearForm",value:function(){this.$form.find("input[type=checkbox]").attr("checked",!1),this.$form.find("input[type=radio]").attr("checked",!1),this.$form.find(".data-picker").each(function(e,i){t.theDataPicker.clear(i)}),this.$form.find("fieldset input[type=radio]:first").each(function(){$(this)[0].checked=!0})}},{key:"_onPopState",value:function(e){var i=this;this._clearForm();var n=this._parseLocationFilterValues(),r=this._parseLocationOrderValue();(this.$form.find("input.order_filter").val(r),n)&&Object.keys(n).forEach(function(t){var e=null;(e=i.$form.find("input#filter_"+t+"_"+n[t])).length>0?e[0].checked=!0:(e=i.$form.find("input#filter_"+t+",select#filter_"+t)).length>0&&e.val(n[t])});$(".data-picker",this.$form).each(function(i,n){var r=e[n.id];r&&t.theDataPicker.load(n,r)}),this.popStateSubmiter&&t.Rails.fire(this.$form[0],"submit")}},{key:"_onFormChange",value:function(){var e=this.$form.attr("action"),i=this.$form.serialize(),n="",r={};t.Rails.fire(this.$form[0],"submit"),n=e.indexOf("?")<0?e+"?"+i:e+"&"+i,$(".data-picker",this.$form).each(function(e,i){r[i.id]=t.theDataPicker.save(i)}),t.Decidim.History.pushState(n,r)}},{key:"_getUID",value:function(){return"filter-form-"+(new Date).setUTCMilliseconds()+"-"+Math.floor(1e7*Math.random())}}]),e}();t.Decidim=t.Decidim||{},t.Decidim.FormFilterComponent=e}(window),function(){var t=window.Decidim.FormFilterComponent;$(function(){$("form.new_filter").each(function(){new t($(this)).mountComponent()})})}();